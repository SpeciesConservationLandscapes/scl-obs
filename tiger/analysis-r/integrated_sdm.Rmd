---
title: "Integrated SDM"
author: "Mari Roberts and Jessica Spencer"
date: "10/31/2019"
output: pdf_document
---
  
**Helper Functions and Packages:**

The following code loads packages if they aren't installed on your machine. The functions.r file will also be loaded which contains functions necessary for the model analyses.
  
```{r message=FALSE, warning=FALSE}
# Load packages or install packages if they don't exist
requiredPackages = c('raster',
                     'fields',
                     'mvtnorm',
                     'matrixStats',
                     'readr',
                     'rgdal',
                     'ggplot2',
                     'dplyr',
                     'tidyverse',
                     'rgbif',
                     'tidyr')
for(p in requiredPackages){
  if(!require(p,character.only = TRUE)) install.packages(p)
  library(p,character.only = TRUE)
}

# load functions in separate R file
source("functions.r")
```

The following shapefile was provided by the tiger team. The shapefile contains the grid cells of Sumatra, Indonesia. Of these grid cells, 394 were surveyed. Grid cells were surveyed for presences of tigers at varying numbers. Presences and absences of tigers were recorded.

```{r}
########################################
# Sumatran Grid Cells
########################################

# import Sumatra shapefile of gridcells used in SO data
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
unzip("data/sumatragridmrgd.zip")
sumatra.map <- readOGR(dsn = ".", layer = "sumatragridmrgd")

# unzip("/Users/mari/statistical_consulting/scl-obs/tiger/data/IDN_adm.zip")
# indonesia_map <- readOGR(dsn = ".", layer = "IDN_adm2")
# import Indonesia administrative regions

# shapefile has to be converted to a dataframe for use in ggplot2
shapefile.df <- fortify(sumatra.map)

# variable names in map
# names(sumatra.map)
# number of unique grid cells
# unique(sumatra.map$ID)

# plot shapefile
map <- ggplot() +
  geom_path(data = shapefile.df,
            aes(x = long, y = lat, group = group),
            color = 'black', fill = 'white', size = .2)

# change  projection
map.projected <- map +
  coord_map()
print(map.projected)
```

## Preparing data for the Code
----------------------------------------------------------------------------
*s.occupancy* - raster with background covatiates that effect occupancy
*s.detection* - raster with background covariates that effect detection
*pb.occupancy* - matrix with covariates that effect occupancy in the locations of detected presences of the opportunistic survey
*pb.detection* - matrix with covariates that effect detection in the locations of detected presences of the opportunistic survey
*y.so* - matrix of detection/non detection of the PA surveys
*so.occupancy* - matrix with covariates that effect occupancy in the locations of PA survey sites
*so.detection* - matrix with covariates that effect detection in the locations of PA survey sites in each survey

## IMPORT DATA: AD HOC, SITE OCCUPANCY, PRESENCE-ABSENCE DATA, COVARIATES  
----------------------------------------------------------------------------

The ad.hoc.original data can be ignored for now.

y.so is the final dataframe for the survey data mentioned in the previous section. As you can see, there are 394 rows representing each site that was surveyed. The number of columns that contains a 0 or 1 corresponds to the number of times each site was surveyed. Not every row has the same number of columns with a 0 or 1 since sites were surveyed a different number of times. NA's are in the trailing columns of the matrix. 

We tried to replace the NA's with 0s because we keep running into problems later...This still didn't fix the issue.

pb.all represents the camera trap data. Each row of latitude and longitude values represents a tiger presence captured on camera. There are 301 observations in total from two datasets provided by Tim O'Brien.

```{r}
# set working directory
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
# setwd("~/Desktop/SpeciesConservationLandscapes/scl-obs/tiger/data")
########################################
# Import Ad hoc data
########################################

# read csv of ad hoc data
#f = file.choose()
#ad.hoc.original  = read.csv(f, skip=1)
#ad.hoc.original = read.csv("Ad Hoc v9 Sumatra 25NOV2019_V2.csv")
ad.hoc.original <- read.csv("Ad Hoc v9 Sumatra 25NOV2019_V2.csv", skip = 1)

########################################
# Import GBIF data
########################################

# source("gbif_idigbio_extraction.R") ---- likely need to tweek this instead of using the following.
#
# sp.in.GBIF <- occ_search(scientificName = c("Panthera tigris",
#                                             "Panthera tigris sondaica",
#                                             "Panthera tigris subsp. sondaica",
#                                             "Panthera tigris subsp. sumatrae",
#                                             "Panthera tigris sumatrae"), return='data')

# # Plot to check GBIF data... maybe some point tweeking required
# gbifmap(sp.in.GBIF, region = "Sumatra") # this function doesn't work amymore...
#
# # make spatial point
# sp.points <- SpatialPoints(cbind(sp.in.GBIF$decimalLongitude,
#                            sp.in.GBIF$decimalLatitude))
# # put georeference
# proj4string(sp.points) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
# centroid <- c(mean(coordinates(sp.points)[,1]),mean(coordinates(sp.points)[,2]))

########################################
# Import site occupancy data
########################################

# This section expands the dataframe so that there is a row for each time an area is surveyed. For example, if an area is surveyed 5 times, there are 5 rows for it, with the observation==1 on the times where a tiger or tiger signs were seen at the location in question. 

# read csv of SO data
#f = file.choose()
#s.o.original = read.csv("Tiger_observation_entry_9_SS_Observations_SUMATRA.csv" )
s.o.original = read.csv("Tiger_observation_entry_9_SS_Observations_SUMATRA.csv")

# rename variables
s.o.original = rename(s.o.original, 
                      num.surveys = X..replicates.surveyed,
                      grid = grid.cell.label, 
                      replicate = replicate..)

# populated the 0's 
a = s.o.original %>% 
  filter(observation == 0) %>% 
  crossing(survey =(1:46)) %>% 
  mutate(good.survey = ifelse(survey>num.surveys, NA, 1)) %>% 
  na.omit()

a = dplyr::select(a,-c(good.survey))

# expand the 1's
b = s.o.original %>% 
  filter(observation == 1) %>% 
  crossing(survey =(1:46)) %>% 
  mutate(good.survey = ifelse(survey>num.surveys, NA, 1)) %>%
  na.omit() %>%
  mutate(true.observation = ifelse(survey!=replicate, 0, 1))

b = dplyr::select(b,-c(good.survey,observation)) %>% 
  rename(observation = true.observation)

# combine the two
so.filled =rbind(a,b)
so.filled_a = 
  dplyr::select(so.filled,-c(replicate)) %>%    
  distinct(survey,
           grid,
           start.date,
           observation,
           .keep_all = T)

#find the overlapping observations
onlyOnes = filter(so.filled_a, observation ==1)
onlyZs = filter(so.filled_a, observation == 0)
reps = plyr::match_df(onlyZs, 
                      onlyOnes,
                      on = c("survey",
                             "start.date",
                             "grid"))

# subtract overlapping observations from the expanded set
final.filled = setdiff(so.filled_a,reps)

final.filled$survey_id = cumsum(!duplicated(final.filled[2:4]))
strip.so = dplyr::select(final.filled,observation,survey,survey_id,grid)

###############################
# y.so
###############################

# This next section will take that dataframe and turn it into a matrix of values. Each row will correspond to a survey.  If the survey happened 24 times, then the corresponding row will have 24 columns - either 0 or 1 - to denote whether a tiger was seen or not. The final dataframe is called *y.so*.
# final site occupancy data
y.so = spread(strip.so,survey,observation)

########################################
# Import camera trap data
########################################

# BBSNP2015 CT data
tiger.CT.observations <- read.csv("Tiger_observation_entry_9_CT_observations_BBSNP_V2.csv")
tiger.CT.entry <- read.csv("Tiger_observation_entry_9_CT_deployments_latlon_BBSNP.csv")

# merge camera trap entries and observation dataframes by deployment ID
pb <- merge(tiger.CT.entry, tiger.CT.observations, 
            by.x = "deployment.ID",
            by.y = "deployment.ID")

# keep variables - not including sex and age for now
pb <- pb %>% dplyr::select(deployment.ID, 
                    project.ID.x, 
                    observation.date.time,
                    camera.latitude,
                    camera.longitude,
                    deployment.date.time,
                    pickup.date.time,
                    bait,
                    large.prey,
                    small.prey,
                    livestock)

# lat/long values only
pb.latlong <- pb %>% dplyr::select(camera.latitude,
                            camera.longitude)

# LeuserCT2013 CT data - missing observation time
tiger.CT.observations2 <- read.csv("Tiger_observation_entry_9_CT_deployments_latlon_Leuser_V2.csv")

pb2 <- tiger.CT.observations2 %>% dplyr::select(project.ID, 
                                         camera.latitude,
                                         camera.longitude,
                                         deployment.date.time,
                                         pickup.date.time,
                                         bait,
                                         large.prey,
                                         small.prey,
                                         livestock)

pb2.latlong <- pb2 %>% dplyr::select(camera.latitude,
                              camera.longitude)

# merge two dataframes of camera trap lat and long values
pb.all <- merge(pb.latlong, pb2.latlong, all.x=TRUE, all.y=TRUE)
head(pb.all)

# spatial points
# should be a list of lat and long values
pb.loc=SpatialPoints(pb.all)
head(pb.all)
```

## Covariates
----------------------------------------------------------------------------

Shapefile data (in gri or grd format) for Indonesia was downloaded from https://www.diva-gis.org/datadown as an exercise. HII and other covariates will be included in the final model. For now, we are using land cover to represent a covariate that affects occcupancy (whether or not a tiger was recorded) and altitude to represent a covariate that affects detection (whether or not someone records a tiger). More than one covariate can be loaded into x.files and w.files.

```{r}
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
# setwd("~/Desktop/SpeciesConservationLandscapes/scl-obs/tiger/data")

###############################
# Covariates
###############################

# covariates should be Formal class RasterLayer
# covatiates that effect occupancy 
# land cover of Indonesia
x.files=c("IDN_cov.grd")

# data from https://www.diva-gis.org/datadown
# covariates should be Formal class RasterLayer
# covariates that effect detection 
# altitude of Indonesia
w.files=c("IDN_alt.grd")

###############################
# s.occupancy - raster with background covatiates that effect occupancy
# should be a Formal class RasterStack
###############################

for (i in c(x.files,w.files)) {
  do.call('=',list(i, raster(i)))
}
s.occupancy = raster(get(x.files[1]))

for (i in x.files) {
  temp=get(i)
  names(temp) = i
  s.occupancy = addLayer(s.occupancy, temp)
}

###############################
# s.detection - raster with background covariates that effect detection
# # should be a Formal class RasterStack
###############################

s.detection= raster(get(w.files[1]))
for (i in w.files) {
  temp=get(i)
  names(temp) = i
  s.detection = addLayer(s.detection, temp)
}

# crop the lidar raster using the vector extent
s.occupancy <- crop(s.occupancy, sumatra.map) # Rasterbrick
s.occupancy <- stack(s.occupancy) # convert to Rasterstack
plot(s.occupancy)

# crop the lidar raster using the vector extent
s.detection <- crop(s.detection, sumatra.map) # Rasterbrick
s.detection <- stack(s.detection) # convert to Rasterstack
plot(s.detection)
```

The following code is likely the issue for the error in the final model. When trying to use the extract function, pb.occupancy and pb.detection are only outputting NAs. This could be an issue with the covariate shapefiles used? So, we simulated data for pb.detection and pb.occupancy.

```{r}
###############################
# pb.occupancy - matrix with covariates that effect occupancy in the locations of detected presences of the opportunistic survey
# pb.detection - matrix with covariates that effect detection in the locations of detected presences of the opportunistic survey
###############################

#.rs.unloadPackage("tidyr") # removes error message "no applicable method for "extract_"
# getting only NA values?
 pb.occupancy=raster::extract(x=s.occupancy,y=pb.loc)
 #raster::extract(s.occupancy)
 pb.detection=extract(s.detection,pb.loc)
 
 #####SKIP TO line 341

# is.complete.pb=complete.cases(pb.detection)&complete.cases(pb.occupancy)
# pb.detection=pb.detection[is.complete.pb,]
# pb.occupancy=pb.occupancy[is.complete.pb,]

###############################
# the following code is simulated because the code above is giving NAs for pb.occupancy and pb.detection
###############################

# 301 rows in this example. When this is changed to 394, it runs. Not sure why?
n = 301
set.seed(1234)
pb.detection <- as.data.frame(rnorm(n,0,1))
pb.occupancy <- as.data.frame(rnorm(n,0,1))

# only include complete cases
is.complete.pb=complete.cases(pb.detection)&complete.cases(pb.occupancy)
pb.detection=pb.detection[is.complete.pb,]
pb.occupancy=pb.occupancy[is.complete.pb,]
```

so.occupancy and so.detection were also simulated. It's unclear in the Koshkina paper and code where these values came from. It's possible they were calculated across the survey area?

```{r}
# set working directory
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
# setwd("~/Desktop/SpeciesConservationLandscapes/scl-obs/tiger/data")

###############################
# so.occupancy - matrix with covariates that effect occupancy in the locations of PA survey sites
# so.detection - matrix with covariates that effect detection in the locations of PA survey sites in each survey
###############################

# This need to be csvs or a matrix of variables and their values across the survey area (-1 to 1 values for example) that affect occupancy
# so.occupancy = read.csv("so_occupancy.csv") # koshkina csv
# this should be the same number of sites surveyed = 394, 48 columns

# simulate data
set.seed(1234)
cov <- matrix(rnorm(1,0,1), nrow=394, ncol=48)
so.occupancy = as.data.frame(cov)

# This need to be csvs or a matrix of variables and their values across the survey area that affect detection
# so.detection = read.csv("so_detection.csv") # koshkina csv
# this should be the same number of sites surveyed = 394, 48 columns

# simulate data
set.seed(1234)
alt <- matrix(rnorm(1,0,1), nrow=394, ncol=48)
so.detection =as.data.frame(alt)

# Only use complete cases
print("removing NA")
is.complete=complete.cases(so.occupancy)&complete.cases(so.detection)&complete.cases(y.so)
so.occupancy=so.occupancy[is.complete,]
so.detection=so.detection[is.complete,]
y.so=y.so[is.complete,]
area.so =pi*0.04

#removing rasters to free the memory
print('removing raster files')
for (i in c(x.files,w.files)) {
	do.call(remove,list(i))
}
remove(is.complete.pb,po,yb.so,po.loc)
```

## Preparing the Data for the Integrated Model

```{r}
# 1. Preparing the data ========================================================
#Preparing Presence-Only data ------------------------------------------------

#turning rasters into tables - background, adding column of ones
X.back = cbind(rep(1, ncell(s.occupancy)), values(s.occupancy))
colnames(X.back)=c("",names(s.occupancy))
W.back = cbind(rep(1, ncell(s.detection)), values(s.detection))
colnames(W.back)=c("",names(s.detection))
# remove all NA values
tmp=X.back[complete.cases(X.back)&complete.cases(W.back),]
W.back=W.back[complete.cases(X.back)&complete.cases(W.back),]
X.back=tmp

#area in squared km -----------------------------------
area.back = rep((xres(s.occupancy)/1000)*(yres(s.occupancy)/1000), nrow(X.back))# each cell
s.area=area.back*nrow(X.back) #study area

# adding column of ones - pb locations
X.po=cbind(rep(1, nrow(as.matrix(pb.occupancy))), pb.occupancy)
W.po=cbind(rep(1, nrow(as.matrix(pb.detection))), pb.detection)

#Preparing Presence-Absence data ------------------------------------------------

#add a column of ones to the PA covariat
#y.so # matrix of presences and absences (when the species was and wasn't present)
J.so=ncol(y.so)
X.so=cbind(rep(1, nrow(as.matrix(so.occupancy))), so.occupancy)
W.so = array(dim=c(nrow(as.matrix(so.detection)), J.so, 3))
W.so[,,1] = 1
#this changes it to a list
# W.so[,,2] = as.matrix(so.detection[,1:2])# if it changes
W.so[,,2] = so.detection# if it changes
#sometimes this (the line below) runs, sometimes it doesnt 
# W.so[,,3] = as.matrix(so.detection[,3:4])# if it changes
```

## Analyzing Data 

### Presence-Only 

Uses a function that fits IPP model. There appears to be an error in the function: 

Error in eigen(hess) : infinite or missing values in 'x'

```{r}
#Analyzing Presence-Only data
#missing values in X
pb.fit=pb.ipp(X.po, W.po,X.back, W.back)
printList(pb.fit)
```

### Presence-Absence 

Uses a function that fits Mackenzie model. 
Error in base::rowSums(x, na.rm = na.rm, dims = dims, ...) : 'x' must be numeric
y.so different number of surveys
could also be an issue with so.detection and so.occupancy
Error in fn(par, ...) : unused argument (trace = 6)

```{r}
# Analyzing presence-absence data
#X must be numeric
so.fit=so.model(X.so,W.so,y.so)
str(y.so)
printList(so.fit)
```

### Integrated Model

Uses a function that fits the integrated model.

Error in base::rowSums(x, na.rm = na.rm, dims = dims, ...) : 'x' must be numeric

```{r}
# Analyzing presence-only data AND presence-absence data
poANDso.fit=pbso.integrated(X.po, W.pb,X.back, W.back,X.so,W.so,y.so)

#### Save model results
save(pb.fit, so.fit, poANDso.fit, file="model.results.rda")

printList(poANDso.fit)
```













