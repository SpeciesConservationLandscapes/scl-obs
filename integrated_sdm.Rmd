---
title: "Integrated SDM"
author: "Mari Roberts and Jessica Spencer"
date: "10/31/2019"
output: pdf_document
---

**Helper Functions and Packages:**
```{r message=FALSE, warning=FALSE}
# Load packages or install packages if they don't exist
requiredPackages = c('raster',
                     'fields',
                     'mvtnorm',
                     'matrixStats',
                     'readr',
                     'rgdal',
                     'ggplot2',
                     'dplyr')
for(p in requiredPackages){
  if(!require(p,character.only = TRUE)) install.packages(p)
  library(p,character.only = TRUE)
}
```

# Import Data

Data is from camera trap data and site occupancy data in Sumatra, Indonesia.

```{r}
# set working directory for chunk of code importing data
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
# Import all csvs in data folder
# temp = list.files(pattern="*.csv")
# for (i in 1:length(temp)) assign(temp[i], read.csv(temp[i]))

# Presence background (PO) 
# Camera trap data
tiger_CT_observations <- read.csv("Tiger_observation_entry_9_CT_observations_BBSNP_V2.csv")
tiger_CT_entry <- read.csv("Tiger_observation_entry_9_CT_deployments_latlon_BBSNP.csv")

# Site occupancy (SO)
# Replicated surveys 
tiger_SS_observations <- read.csv("Tiger_observation_entry_9_SS_Observations_SUMATRA.csv")
tiger_SS_entry <- read.csv("Tiger_observation_entry_9_SS_Survey_SUMATRA.csv")

# names(tiger_CT_observations)
# names(tiger_SS_observations)
```

##Site Occupancy (SO) Data

394 grid cells were surveyed in Sumatra, Indonesia.

```{r}
# number of absences and occurences
table(tiger_SS_observations$observation)

# number of unique grid cells
unique(tiger_SS_observations$grid.cell.label)
```

###Preparing data for the Code
--------------------------------------
All the data required for this function is stored in a file data.rda
  *s.occupancy* - raster with background covatiates that effect occupancy
  *s.detection* - raster with background covariates that effect detection
  
  pb.occupancy - matrix with covariates that effect occupancy in the locations of detected presences of the opportunistic survey
  pb.detection - matrix with covariates that effect detection in the locations of detected presences of the opportunistic survey

  y.so - matrix of detection/non detection of the PA surveys
  
  so.occupancy - matrix with covariates that effect occupancy in the locations of PA survey sites
  so.detection - matrix with covariates that effect detection in the locations of PA survey sites in each survey

#0. Look at other stuff



#1. Matching y.so


This section expands the dataframe so that there is a row for each time an area is surveyed.  For example, if an area is surveyed 5 times, there are 5 rows for it, with the observation==1 on the times where a tiger or tiger signs were seen at the location in question. 

```{r}
setwd("/Users/mari/statistical_consulting/scl-obs/tiger/data")
s.o.original = read.csv("Tiger_observation_entry_9_SS_Observations_SUMATRA.csv")
head(s.o.original)
names(s.o.original)
#better titles for things
s.o.original = rename(s.o.original, num.surveys = X..replicates.surveyed,grid = grid.cell.label, replicate = replicate..)
s.o.original
#populated the 0's 
a =s.o.original %>% filter(observation == 0) %>% crossing(survey =(1:46)) %>% 
  mutate(good.survey = ifelse(survey>num.surveys, NA, 1)) %>% 
  na.omit()
a = dplyr::select(a,-c(good.survey))
#expand the 1's
b =s.o.original %>% filter(observation == 1) %>% crossing(survey =(1:46)) %>% 
  mutate(good.survey = ifelse(survey>num.surveys, NA, 1)) %>%
  na.omit() %>%
  mutate(true.observation = ifelse(survey!=replicate, 0, 1))
b = dplyr::select(b, -c(good.survey,observation)) %>% rename(observation = true.observation)
#combine the two
so.filled =rbind(a,b)
so.filled_a = dplyr::select(so.filled,-c(replicate)) %>%    distinct(survey,grid,start.date,observation,.keep_all = T)
#find the overlapping observations
onlyOnes = filter(so.filled_a, observation ==1)
onlyZs = filter(so.filled_a, observation == 0)
reps = plyr::match_df( onlyZs, onlyOnes,on =c("survey","start.date","grid"))
#subtract overlapping observations from the expanded set, you get the final filled version
final.filled = setdiff(so.filled_a,reps)
head(final.filled)

```

This next section will take that dataframe and turn it into a matrix of values. Each row will correspond to a survey.  If the survey happened 24 times, then the corresponding row will have 24 numbers - either 0 or 1 - to denote whether a tiger was seen or not. 

```{r}
final.filled$survey_id = cumsum(!duplicated(final.filled[2:4]))
head(final.filled)
```

```{r}
strip.so = dplyr::select(final.filled,observation,survey,survey_id,grid)
head(strip.so)
```

```{r}
#now flip it so that it's long
spread = spread(strip.so,survey,observation)
head(spread)
```

**Presence Background (PB) Data**

```{r}
# merge camera trap entries and observation dataframes by deployment ID
pb_data <- merge(tiger_CT_entry, tiger_CT_observations, 
                 by.x = "deployment.ID",
                 by.y = "deployment.ID")

# remove columns where all values are NA
pb_data <- pb_data[,colSums(is.na(pb_data))<nrow(pb_data)]

# create one column for observations with sex/age as factor levels
# change to ifelse statement to include cubs (erroring)?
pb_data <- pb_data %>% 
  mutate(observation = case_when(
    (X..adult.males == 1) ~ "maleAdult",
    (X..adult..females == 1) ~ "femaleAdult",
    (X..adults.sex.unknown == 1) ~ "unknownAdult",
    (X..Subadults..either.sex...1.2.years.old. == 1) ~ "subAdult",
    #(X..cubs..either.sex...1.12.month.old. == 1) ~ "cub",
    TRUE ~ NA_character_
  ))
```

## Sumatra Shapefile

There are 1921 grid cells for Sumatra, Indonesia.

```{r message=FALSE, warning=FALSE}
unzip("/Users/mari/statistical_consulting/scl-obs/tiger/data/sumatragridmrgd.zip")

sumatra_map <- readOGR(dsn = ".", layer = "sumatragridmrgd")

# shapefile has to be converted to a dataframe for use in ggplot2
shapefile_df <- fortify(sumatra_map)

# variable names in map
names(sumatra_map)

# number of unique grid cells
unique(sumatra_map$ID)

# plot shapefile
map <- ggplot() +
geom_path(data = shapefile_df, 
          aes(x = long, y = lat, group = group),
          color = 'black', fill = 'white', size = .2)
```

```{r}
# change  projection
map_projected <- map +
  coord_map()
print(map_projected)
```

## Add data to shapefile

```{r}
# add SO data to Sumatra grid
str(tiger_SS_observations)
# factor observations
tiger_SS_observations$observation <- factor(tiger_SS_observations$observation)
sumatra_map@data <- data.frame(sumatra_map@data, 
                               tiger_SS_observations[match(sumatra_map@data[,"ID"],
                                                           tiger_SS_observations[,"grid.cell.label"]),])
head(sumatra_map@data)
```


